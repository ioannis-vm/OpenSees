# Script used to test the implementation of
# Pinching4Material::sendSelf and Pinching4Material::recvSelf
# 
# August 17, 2023
# 
# John Vouvakis Manousakis
# UC Berkeley

# Step 1: An analysis without invoking the DataBase commands.

wipe

model basic -ndm 1 -ndf 1

node 101 0.00
node 102 0.00
fix 101 1

set matTag 501

uniaxialMaterial Steel4 $matTag 50.00 29000.00 -kin 0.003 25.00 0.90 0.15 -iso 0.0025 1.34 0.004 1.0 1.0

element zeroLength 201 101 102 -mat 501 -dir 1

pattern Plain 2010 Linear {
    load 102 1.00
}

system UmfPack
numberer Plain
constraints Plain

recorder Element -file "/tmp/out_defo_nodb" -ele 201 material 1 strain
recorder Element -file "/tmp/out_force_nodb" -ele 201 material 1 stress

set rotations {
0.00 0.005 0.010 0.015 0.020 0.03
0.025 0.020 0.010 0.00 -0.02
-0.01 0.00 0.02 0.04
}

for {set i 0} {$i < [expr {[llength $rotations] - 1}]} {incr i} {
    set increment [expr {[lindex $rotations [expr {$i + 1}]] - [lindex $rotations $i]}]
    test "NormDispIncr" 1e-6 5000 0
    algorithm "Newton"
    integrator "DisplacementControl" 102 1 $increment
    analysis "Static"
    set flag [analyze 1]
    if {$flag != 0} {
	puts $i
	break
    }
}

set rotations {
0.04 0.02 0.01 0.00 -0.02 -0.005 0.005 0.00
}

for {set i 0} {$i < [expr {[llength $rotations] - 1}]} {incr i} {
    set increment [expr {[lindex $rotations [expr {$i + 1}]] - [lindex $rotations $i]}]
    test "NormDispIncr" 1e-6 5000 0
    algorithm "Newton"
    integrator "DisplacementControl" 102 1 $increment
    analysis "Static"
    set flag [analyze 1]
    if {$flag != 0} {
	puts $i
	break
    }
}


# Step 2: An analysis invoking the DataBase commands.

wipe

model basic -ndm 1 -ndf 1

node 101 0.00
node 102 0.00
fix 101 1

# uniaxialMaterial Elastic $matTag 100.00
uniaxialMaterial Steel4 $matTag 50.00 29000.00 -kin 0.003 25.00 0.90 0.15 -iso 0.0025 1.34 0.004 1.0 1.0

element zeroLength 201 101 102 -mat 501 -dir 1

pattern Plain 2010 Linear {
    load 102 1.00
}


system UmfPack
numberer Plain
constraints Plain

recorder Element -file "/tmp/out_defo_db" -ele 201 material 1 strain
recorder Element -file "/tmp/out_force_db" -ele 201 material 1 stress

set rotations {
0.00 0.005 0.010 0.015 0.020 0.03
0.025 0.020 0.010 0.00 -0.02
-0.01 0.00 0.02 0.04
}

for {set i 0} {$i < [expr {[llength $rotations] - 1}]} {incr i} {
    set increment [expr {[lindex $rotations [expr {$i + 1}]] - [lindex $rotations $i]}]
    test "NormDispIncr" 1e-6 5000 0
    algorithm "Newton"
    integrator "DisplacementControl" 102 1 $increment
    analysis "Static"
    set flag [analyze 1]
    if {$flag != 0} {
	puts $i
	break
    }
}

# save and then restore model state
database File "/tmp/ops_database/opsdb"
save 6040

# Optional: wipe
wipe
database File "/tmp/ops_database/opsdb"

restore 6040

recorder Element -file "/tmp/out_defo_db" -ele 201 material 1 strain
recorder Element -file "/tmp/out_force_db" -ele 201 material 1 stress

system UmfPack
numberer Plain
constraints Plain

set rotations {
0.04 0.02 0.01 0.00 -0.02 -0.005 0.005 0.00
}

for {set i 0} {$i < [expr {[llength $rotations] - 1}]} {incr i} {
    set increment [expr {[lindex $rotations [expr {$i + 1}]] - [lindex $rotations $i]}]
    test "NormDispIncr" 1e-6 5000 0
    algorithm "Newton"
    integrator "DisplacementControl" 102 1 $increment
    analysis "Static"
    set flag [analyze 1]
    if {$flag != 0} {
	puts $i
	break
    }
}
